name: R-CMD-check

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    check:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up R
              uses: r-lib/actions/setup-r@v2

            - name: Restore renv (if present) or install deps
              run: |
                  Rscript -e "if (file.exists('renv.lock')) { install.packages('renv', repos='https://cran.rstudio.com'); renv::restore() } else { install.packages('remotes', repos='https://cran.rstudio.com'); remotes::install_deps(dependencies = TRUE) }"

            - name: Lint package
              run: Rscript -e "if (!requireNamespace('lintr', quietly=TRUE)) install.packages('lintr', repos='https://cran.rstudio.com'); lintr::lint_package()"

            - name: Run R CMD check
              env:
                  _R_CHECK_FORCE_SUGGESTS_: false
              run: |
                  R CMD check --no-manual --as-cran .

            - name: Run tests (extra)
              run: Rscript -e "if (!requireNamespace('testthat', quietly=TRUE)) install.packages('testthat', repos='https://cran.rstudio.com'); testthat::test_dir('tests/testthat')"
